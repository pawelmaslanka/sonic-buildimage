#!/usr/bin/make -f
# -*- makefile -*-

# NOTE: Whole file was inspired by rules for saibcm-modules package from SONiC repo:
# https://github.com/sonic-net/sonic-buildimage/blob/master/platform/broadcom/saibcm-modules/debian/rules

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

psource:=openbcm-source
sname:=openbcm

PKG_NAME=openbcm_6.5.21_amd64.deb
PACKAGE=openbcm
MA_DIR ?= /usr/share/modass
KVERSION ?= 5.10.0-23-2-amd64
KERNVERSION ?= 5.10.0-23-2

platform=x86-smp_generic_64-2_6
TARGET=unix-user

SDK_VER = 6.5.21

KERNLDIR = /sonic/src/sonic-linux-kernel/linux-5.10.179

EXTRA_CFLAGS = -I$(KERNLDIR) -lc -isystem $(SYSINC) -Iinclude -I$(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-amd64/usr/src/linux-headers-$(KERNVERSION)-amd64/include -I$(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-amd64/usr/src/linux-headers-$(KERNVERSION)-amd64/arch/x86/include/generated/uapi -I$(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-amd64/usr/src/linux-headers-$(KERNVERSION)-amd64/include/generated/uapi -I$(KERNLDIR)/arch/x86/include -I$(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-amd64/usr/src/linux-headers-$(KERNVERSION)-amd64/arch/x86/include/generated -I$(KERNLDIR)/arch/x86/include/uapi -I$(KERNLDIR)/include -I$(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-amd64/usr/src/linux-headers-$(KERNVERSION)-amd64/include/generated -I$(KERNLDIR)/include/uapi -include $(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-amd64/usr/src/linux-headers-$(KERNVERSION)-amd64/include/generated/autoconf.h -D__KERNEL__ -DNDEBUG -Wundef -Wno-error=unused-value -Wno-error=cpp -Wstrict-prototypes -Wno-trigraphs -fno-strict-aliasing -fno-common -Wno-format-security -O2 -m64 -mtune=generic -mno-red-zone -mcmodel=kernel -funit-at-a-time -fstack-protector -DCONFIG_AS_CFI=1 -DCONFIG_AS_CFI_SIGNAL_FRAME=1 -pipe -Wno-sign-compare -fno-asynchronous-unwind-tables -fno-omit-frame-pointer -Wdeclaration-after-statement -Wno-pointer-sign -fno-strict-overflow -fno-dwarf2-cfi-asm -fno-builtin -Wno-int-to-pointer-cast -fno-pie -D\"KBUILD_STR(s)=\#s\"
EXTRA_KFLAGS=-I$(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-amd64/usr/src/linux-headers-$(KERNVERSION)-amd64/arch/x86/include/generated/uapi

EXTRA_KERNEL_FLAGS = -include $(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-amd64/usr/src/linux-headers-$(KERNVERSION)-amd64/include/generated/autoconf.h -I$(KERNLDIR) $(SYSINC) -I$(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-amd64/usr/src/linux-headers-$(KERNVERSION)-amd64/arch/x86/include/generated -I$(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-amd64/usr/src/linux-headers-$(KERNVERSION)-amd64/arch/x86/include/generated/uapi -I$(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-amd64/usr/src/linux-headers-$(KERNVERSION)-amd64/include/generated/uapi -Iinclude -I$(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-amd64/usr/src/linux-headers-$(KERNVERSION)-amd64/include -I$(KERNLDIR)/arch/x86/include  -I$(KERNLDIR)/arch/x86/include/uapi -I$(KERNLDIR)/include -I$(KERNLDIR)/include/uapi

SDK=/sonic/src/OpenBCM/sdk-$(SDK_VER)
SDKLT=$(SDK)/libs/sdklt

-include $(MA_DIR)/include/generic.make
-include $(MA_DIR)/include/common-rules.make

SDKLT_CFLAGS = "-Wno-error -Wno-stringop-truncation"
SDKLT_EXTRA_CFLAGS = -O2 -DSYS_BE_PIO=0 -DSYS_BE_PACKET=0 -DSYS_BE_OTHER=0 -DLE_HOST=1 -Wno-error -Wno-error=incompatible-pointer-types -Wno-error=int-conversion -Wno-error=implicit-function-declaration -Wno-error=cpp -Wno-error=format-overflow= -Wno-error=maybe-uninitialized -Wno-error=stringop-truncation -Wno-error=stringop-overflow= -Wno-error=zero-length-bounds -Wno-zero-length-bounds -Wno-error=array-bounds -Wno-array-bounds -Wno-error=unused-function -Wno-unused-function -Wno-error=restrict -Wno-restrict -Wno-error=address-of-packed-member -Wno-address-of-packed-member -Wno-error=unused-variable -fno-strict-aliasing -Werror=strict-aliasing


# Set SDKLT flags to build accoridng to guide at libs/sdklt/doc/DOC/build.dox
SDKLT_CPPFLAGS = "-DSYS_BE_PIO=0 -DSYS_BE_PACKET=0 -DSYS_BE_OTHER=0"

SDKLT_FLAGS = CROSS_COMPILE=x86_64-linux-gnu- \
    LINUX_INCLUDE=$(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-amd64/usr/src/linux-headers-$(KERNVERSION)-amd64/include \
    KDIR=$(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-common/usr/src/linux-headers-$(KERNVERSION)-common \
    ARCH=x86_64 \
    kernel_version=5_10 \
    YAML=/usr \
    YAML_LIBDIR=/usr/lib/x86_64-linux-gnu \
    FEATURE_LIST="$(FEATURE_LIST)" CFGFLAGS="$(CFGFLAGS)" ALL_LTSW_CHIPS=$(ALL_LTSW_CHIPS) \
    LTSW_CHIPS=1 BUILD_SDKLT=1 \
    SYSTEM_INTERFACE=ngbde INCLUDE_KNET=1 \
    ISSU=1 \
    SDK_CFLAGS="-DSYS_BE_PIO=0 -DSYS_BE_PACKET=0 -DSYS_BE_OTHER=0 -DLE_HOST=1 -Wno-error=unused-but-set-variable -Wno-error=maybe-uninitialized -Wno-error=aggressive-loop-optimizations -Wno-error=sizeof-pointer-div -Wno-error=memset-elt-size -Wno-stringop-overflow -Wno-stringop-truncation -Wno-error=restrict -Wno-address-of-packed-member -Wno-error=uninitialized -Wno-error=format-overflow -fcommon  -DUSE_LINUX_BDE_MMAP=1 -Wno-error=unused-value -Wno-error=unused-function -Wno-error=cpp -Wno-error=array-bounds -Wno-error=strict-overflow -DUSE_LINUX_BDE_MMAP=1 -Wno-error=unused-value -Wno-error=unused-function -Wno-error=cpp -Wno-error=array-bounds -Wno-error=strict-overflow -Wno-error=strict-aliasing" \
	SDK_CPPFLAGS=$(SDKLT_CPPFLAGS)

BCMLRD_FLAGS=-DSYS_BE_PIO=0 -DSYS_BE_PACKET=0 -DSYS_BE_OTHER=0 -I$(SDKLT)/bcmlrd/include -I$(SDKLT)/bcmdrd/include -I$(SDKLT)/bcmmgmt/include -I$(SDKLT)/bcmltd/include -I$(SDKLT)/shr/include -I$(SDKLT)/bsl/include -I$(SDKLT)/sal/include $(SDK_CFLAGS)
SDKLT_PHYMOD_CFLAGS="$(SDKLT_EXTRA_CFLAGS)" -I/sonic/src/OpenBCM/sdk-6.5.21/libs/sdklt/bsl/include

PHYMOD_ADD_CFLAGS=

FEATURE_LIST=BFD PTP CINT L3 I2C MEM_SCAN EDITLINE BCM_SAL_PROFILE CUSTOMER TEST CHASSIS MSTP KNET TCB PSTATS FLOWTRACKER IFA COLLECTOR TELEMETRY INT
BCM_PTL_SPT = 1

BCM_56880_A0 = 1

CFGFLAGS += -DBCM_WARM_BOOT_SUPPORT
CFGFLAGS += -DBCM_WARM_BOOT_SUPPORT_SW_DUMP
CFGFLAGS += -DNO_CONTROL_C


hsdk_build: sdklt

sdklt:
	CROSS_COMPILE=x86_64-linux-gnu- \
	LINUX_INCLUDE=$(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-amd64/usr/src/linux-headers-$(KERNVERSION)-amd64/include \
	KDIR=$(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-common/usr/src/linux-headers-$(KERNVERSION)-common \
	ARCH=x86_64 \
	kernel_version=5_10 \
	YAML=/usr \
	YAML_LIBDIR=/usr/lib/x86_64-linux-gnu \
	FEATURE_LIST="$(FEATURE_LIST)" CFGFLAGS="$(CFGFLAGS)" ALL_LTSW_CHIPS=1 \
	SYSTEM_INTERFACE=ngbde INCLUDE_KNET=1 PHYMOD_SUPPORT=1 PORTMOD_SUPPORT=1 \
	kernel_version=5_10 \
	SDK_CFLAGS="-Wno-error=unused-but-set-variable -Wno-error=maybe-uninitialized -Wno-error=aggressive-loop-optimizations -Wno-error=sizeof-pointer-div -Wno-error=memset-elt-size -Wno-stringop-overflow -Wno-stringop-truncation -Wno-error=restrict -Wno-address-of-packed-member -Wno-error=uninitialized -Wno-error=format-overflow -fcommon  -DUSE_LINUX_BDE_MMAP=1 -Wno-error=unused-value -Wno-error=unused-function -Wno-error=cpp -Wno-error=array-bounds -Wno-error=strict-overflow -DUSE_LINUX_BDE_MMAP=1 -Wno-error=unused-value -Wno-error=unused-function -Wno-error=cpp -Wno-error=array-bounds -Wno-error=strict-overflow -Wno-error=strict-aliasing"
	$(MAKE) KDIR=$(KERNLDIR)/debian/build/build_amd64_none_amd64 TARGET_PLATFORM=native -C $(SDKLT)/appl/demo all SDK=$(SDKLT) SDKLT=$(SDKLT) SYSTEM_INTERFACE=ngbde SDK_CFLAGS="-DSYS_BE_PIO=0 -DSYS_BE_PACKET=0 -DSYS_BE_OTHER=0 -DLE_HOST=1" CFLAGS="$(SDKLT_EXTRA_CFLAGS) -I$(SDKLT)/lib/include/sdklt/shr" BLDDIR=$(SDK)/build SDK_BLDDIR=$(SDK)/build/sdklt SDK_DSTDIR=$(SDK)/build/sdklt/lib TARGET=unix-user platform=x86-smp_generic_64-2_6

hsdk_env:
	echo "Prepare HSDK env"

	cd /; sudo mkdir -p /lib/modules/$(KERNVERSION)-amd64
	cd /; sudo rm /lib/modules/$(KERNVERSION)-amd64/build 2>/dev/null || true
	cd /; sudo rm /lib/modules/$(KERNVERSION)-amd64/source 2>/dev/null || true
	sudo rm -Rf /usr/src/linux-headers-$(KERNVERSION)-common
	cd /; sudo ln -s $(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-common/usr/src/linux-headers-$(KERNVERSION)-common/ /lib/modules/$(KERNVERSION)-amd64/source
	cd /; sudo ln -s $(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-amd64/usr/src/linux-headers-$(KERNVERSION)-amd64/ /lib/modules/$(KERNVERSION)-amd64/build
	cd /; sudo ln -s $(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-common/usr/src/linux-headers-$(KERNVERSION)-common/ /usr/src/linux-headers-$(KERNVERSION)-common
	sudo rm -Rf /usr/src/linux-headers-5.10.0-23-2-common/scripts 2>/dev/null || true
	ln -s /usr/src/linux-kbuild-5.10/scripts /usr/src/linux-headers-5.10.0-23-2-common/scripts
	cd /; sudo ln -s $(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-amd64/usr/src/linux-headers-$(KERNVERSION)-amd64/include/generated/ /usr/src/linux-headers-$(KERNVERSION)-common/include/generated 2>/dev/null || true
	cd /; cp $(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-amd64/usr/src/linux-headers-$(KERNVERSION)-amd64/include/generated/autoconf.h /usr/src/linux-headers-$(KERNVERSION)-common/include/generated/ 2>/dev/null || true
	cd /; sudo ln -s $(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-amd64/usr/src/linux-headers-$(KERNVERSION)-amd64/arch/x86/include/generated/ /usr/src/linux-headers-$(KERNVERSION)-common/arch/x86/include/generated 2>/dev/null || true
	cd /; sudo ln -s $(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-amd64/usr/src/linux-headers-$(KERNVERSION)-amd64/arch/x86/module.lds /usr/src/linux-headers-$(KERNVERSION)-common/arch/x86/module.lds 2>/dev/null || true
	cd /; sudo ln -s $(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-amd64/usr/src/linux-headers-$(KERNVERSION)-amd64/include/config/ /usr/src/linux-headers-$(KERNVERSION)-common/include/config 2>/dev/null || true
	cd /; sudo cp $(KERNLDIR)/debian/linux-headers-$(KERNVERSION)-amd64/usr/src/linux-headers-$(KERNVERSION)-amd64/Module.symvers /usr/src/linux-headers-$(KERNVERSION)-common/Module.symvers 2>/dev/null || true
	(cd /sonic/src/OpenBCM/sdk-6.5.21; git clean --force -d -x; git reset --hard; patch -p1 < /sonic/src/openbcm/0001-enable-build-on-sonic-202305.patch; patch -p1 < /sonic/src/openbcm/0002-cpp-rename-delete-identifier.patch; cd /sonic/src/openbcm)

kdist_config: prep-deb-files

kdist_clean: clean
	dh_testdir
	dh_clean

configure: configure-stamp
configure-stamp:
	dh_testdir
	touch configure-stamp


build-arch: configure-stamp  build-arch-stamp
build-arch-stamp: hsdk_env hsdk_build
	dh_testdir

build-indep:  configure-stamp build-indep-stamp
build-indep-stamp:
	dh_testdir
	touch $@

build: build-arch

clean:
	dh_testdir
	#dh_testroot
	rm -f build-arch-stamp build-indep-stamp configure-stamp
	dh_clean

install: DH_OPTIONS=
install: build
	dh_testdir
	dh_testroot
	dh_prep
	dh_installdirs
	dh_install

binary-indep: build install
	dh_testdir -i
	dh_testroot -i
	dh_installchangelogs  -i
	dh_installdocs -i
	dh_installexamples -i
	dh_installman -i
	dh_link -i
	dh_compress -i
	dh_fixperms -i
	dh_installdeb -i
	dh_installdeb -i
	dh_shlibdeps -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i --filename $(PKG_NAME)

binary-arch: build install
	dh_testdir -s
	dh_testroot -s

	dh_installdocs -s
	dh_installexamples -s
	dh_installmenu -s
	dh_installmodules -s
	dh_systemd_enable -s
	dh_installinit -s
	dh_systemd_start -s
	dh_installcron -s
	dh_installinfo -s
	dh_installchangelogs  -s
	dh_strip -s
	dh_link -s
	dh_compress -s
	dh_fixperms -s
	dh_makeshlibs -s
	dh_installdeb -s
	dh_shlibdeps -s
	dh_gencontrol -s -- -n"$(PKG_NAME)"
	dh_md5sums -s
	dh_builddeb -s --filename $(PKG_NAME)

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install configure binary-modules kdist kdist_configure kdist_image kdist_clean
